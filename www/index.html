<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Techbrowser Powered Search</title>
		<link href="css/reset.css" rel="stylesheet" type="text/css"  />
		<link href="css/index.css" rel="stylesheet" type="text/css" />
		<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css">
		<link href="css/jquery.loading.1.6.css" rel="stylesheet" type="text/css"  />
		
		<!-- social 
		<script type="text/javascript" src="http://www.google.com/friendconnect/script/friendconnect.js"></script>
		<script src="http://connect.facebook.net/en_US/all.js"></script>
		-->
	</head>

	<body class="body">
		<!-- needed by fb -->
		<div id="fb-root"></div>
		
		<!-- jquery -->    
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/jquery-ui.min.js"></script>
		<!-- loading -->
		<script type="text/javascript" src="libs/jquery/loading.16.4/jquery.loading.1.6.4.js"></script>
		
		<script type="component" source="entriesCanvas" id="entriesCanvas"></script>
		<script type="component" source="inputBox" id="inputBox"></script>
		
		
		<script src="./componentjs/component.js"></script>
		<script src="./componentjs/component-extend-emitter.js"></script>
		<script src="./appContext.js"></script>
		
		<script>
			Component.overrideCurrent();
			
			var _self = this;
			var animated = false;
			var normalizationTimeoutId = null;
			var appContext = new AppContext();
			
			this.inputBox = $("#inputBox")[0];
			
			this.inputBox.on("autocomplete", function(event){
				appContext.getTag(event.request,event.callback);
			});
			
			this.inputBox.on("save", function(entry){
				appContext.saveEntry(entry.url, entry.tags, function(response){
					if(response != "OK") {
						entry.errorHandler("failed to save entry due "+response);
						return;
					}
					
					this.inputBox.setTags(entry.tags);
					this.inputBox.emit("query", entry.tags);
				})
			});
			
			this.inputBox.on("urlInputComplete", function(terms){
				_self.inputBox.setLoading(true);
				appContext.getTags(terms, function(response){
					_self.inputBox.setLoading(false);
					if(response.length > 0)
						_self.inputBox.setTags(response);
				});
			});
			
			this.inputBox.on("query", function(terms){
				if(typeof history.pushState === "function")
					history.pushState({terms: terms}, "TechbrowserSearch", "#/"+terms.join("/")); // XXX
				else
					window.location.hash = "#/"+terms.join('/');
				
				appContext.query(terms, function(response){
					$("#resultsList").fadeOut("fast",function(){
						
						$("#resultsList")[0].clearItems();
			        	if(response.length){
			        		
			        		if(response.length > 1)
			        			$("#entriesCanvas")[0].setCircleData(0,'number',response.length+" matches");
			        		
			        		if(normalizationTimeoutId)
			        			clearTimeout(normalizationTimeoutId);
			        		
			        		if(!animated) {
			        			$("#inputBox").animate({ 
								    top: "0%",
								    marginTop: "250px",
								  }, 
								  200);
			        			
			        			$(".ui-autocomplete").animate({ 
								    top: "290px"
								  }, 
								  500);
			        			
			        			$("#entriesCanvas").animate({ 
								    top: "0%",
								    marginTop: "0px",
								  }, 
								  200);
			        			
								$("#resultsList").animate({ 
									marginTop: "20px"
								  }, 200 );
								
								animated = true;
			        		}
			        		
			        		
							var resultsList = $("#resultsList");
							for(var i=0;i<response.length;i++){
								resultsList[0].addItem(response[i]);
							}
							
							
						} else {
							normalizationTimeoutId = setTimeout(function(){
								if(animated) {
									$("#entriesCanvas").animate({ 
									    top: "50%",
									    marginTop: "-221px"
									  }, 200 );
									
									$("#inputBox").animate({ 
									    top: "50%",
									    marginTop: "10px"
									  }, 200 );
									
									$(".ui-autocomplete").animate({ 
									    top: "530px"
									  }, 
									  500);
									
									$("#resultsList").animate({ 
										marginTop: "30px"
									  }, 200 );
									animated = false;
								}
							}, 2000);
							
							$("#resultsList")[0].setEmpty();
						}
			        	
			        	$("#resultsList").fadeIn("fast");
					});
				});
			});
			
			window.onpopstate = function(event) {
				if(typeof event.terms != 'undefined') {
					this.inputBox.setTags(event.terms);
					this.inputBox.emit("query", event.terms);
				}
			}
			
			var hash = window.location.hash;
			if(hash.length > 0) {
				terms = hash.substr(2).split("/");
				this.inputBox.setTags(terms);
				this.inputBox.emit("query", terms);
			}
			
			/*var appSocialContext = new AppSocialContext();
			appSocialContext.hookToSocialLogins();*/
			
		</script>
		
		<!-- analytics -->
		<script type="text/javascript">

		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', appContext.googleAnalyticsKey]);
		  _gaq.push(['_trackPageview']);
		
		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		
		</script>
	</body>
</html>
